---
title: "Study of PK/PD Index for Linezolid specific to CSF infections"
editor_options: 
  chunk_output_type: console
---

## Settings & Dependencies

Load necessary library, dependencies and settings for the project. Just run the block code to generate the same result than the article. Otherwise, if you want to play simulations, you can change the parameters, dosing regimens...

```{r}
#| echo: false

####
## Load dependencies
####
library(mrgsolve)       # Simulation package
library(dplyr)          # Data manipulation
library(tidyr)          # Data manipulation
library(purrr)          # Data manipulation
library(tibble)         # Data manipulation
library(ggplot2)        # Plotting

# If doesn't exist, create a folder for result plots
if (!dir.exists("results")) {
  dir.create("results")
}

# Load the model
model_file <- mread("model/Mouse_model_v2")

####
## Specify your entries
####

# Define the maximum thread number to use for simulations
thread_number = 9

# These PK parameters will be used later in the Rscripts.
# So we define them here, to avoid to hardcode values.
CL = 0.76
V1 = 0.15
FU = 0.69

# Specific model parameters for each strains
model_list <- list(
    # S. Aureus
    SA6538p = param(model_file, PCL=CL, B0 = 6.09, Bmax = 9.26, Kg = 1.09,
                    Emax = 1.93, EC50 = 1.1, Kon = 0.016, MIC = 2.0)
)

# Specify AMT choosen for fractioned doses
fractioned_daily_AMT <- c(2.5, 93.75, 185, 276, 637.5, 459, 550, 641, 733, 824, 915, 1003.5, 1098, 1189, 1280)

# Specify the number of simulated patients
i_data <- expand.idata(ID = 1:100)

####
## Execute the main script
####
source("RScripts/main_script_for_mouse.R")

```

## PKPD Plots generation

The code below will generate PK/PD index plots for fCmax/MIC, fAUC/MIC and fT>MIC for CSF target.

```{r}
source("RScripts/pkpd_index_plots_script.R")

pkpd_plot <- PKPD_index_plots(obs_data = data[["obs_mean"]], 
                             pred_data = data[["pred_data"]], 
                             title = "Reproduction of Andes PKPD Index for Linezolid in the mouse" ,
                             file_name = "Andes PKPD Index for Linezolid.png")
```

## PK & PD Analysis

```{r}
## Summarize data
summary_fractioned <- sim_results_fractioned[["fractioned_results"]][["SA6538p"]] |>
  group_by(DoseGroup, AMT, time) |>
  summarize(
    C_CENTRAL = mean(C_CENTRAL),
    Log10CFU = mean(Log10CFU)
    )

## PK plots
### Plasma PK for fractioned doses
summary_fractioned |>
  filter(AMT != 0) |>
  ggplot(aes(x = time, y = C_CENTRAL, color = as.factor(DoseGroup))) +
  geom_line(linewidth = 0.75) +
  facet_wrap(~AMT, ncol = 3, scales = "free_y") +
  labs(
    x = "Time (h)", 
    y = "Linezolid concentrations (mg/L)", 
    title = "Plasma PK of Linezolid for q24h, q12h, q8h, q4h",
    color = "Dosing regimens"
  ) +
  scale_x_continuous(breaks = seq(0, 24, 4))
### PD for fractioned doses
summary_fractioned |>
  filter(AMT != 0) |>
  ggplot(aes(x = time, y = Log10CFU, color = as.factor(DoseGroup))) +
  geom_line(linewidth = 0.75) +
  facet_wrap(~AMT, ncol = 3, scales = "free_y") +
  labs(
    x = "Time (h)", 
    y = "Linezolid concentrations (mg/L)", 
    title = "CSF PD of Linezolid for q24h, q12h, q8h, q4h",
    color = "Dosing regimens"
  ) +
  scale_x_continuous(breaks = seq(0, 24, 4))
```
